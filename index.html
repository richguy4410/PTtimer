<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발표 스크립트 생성기</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter (for a clean, modern look) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom font family for Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid #ef4444; /* Red border for errors */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl border border-blue-200">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">
            발표 스크립트 생성기 ✍️
        </h1>

        <!-- 입력 폼 섹션 -->
        <form id="scriptForm" class="space-y-6 mb-8">
            <div>
                <label for="topic" class="block text-lg font-semibold text-gray-700 mb-2">
                    발표 주제:
                </label>
                <input
                    type="text"
                    id="topic"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                    placeholder="예: 인공지능의 미래"
                    required
                />
            </div>

            <div>
                <label for="pdfUpload" class="block text-lg font-semibold text-gray-700 mb-2">
                    PDF 자료 업로드 (선택 사항):
                </label>
                <input
                    type="file"
                    id="pdfUpload"
                    accept=".pdf"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
                <p id="pdfLoadingStatus" class="text-sm text-gray-500 mt-2 hidden">
                    <svg class="animate-spin inline-block -ml-1 mr-2 h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    PDF를 읽는 중...
                </p>
            </div>

            <div>
                <label for="considerations" class="block text-lg font-semibold text-gray-700 mb-2">
                    주요 고려 사항 (핵심 내용, 강조할 부분 등):
                </label>
                <textarea
                    id="considerations"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm h-32 resize-y"
                    placeholder="예: 기술 발전의 속도, 윤리적 문제, 사회적 영향, 새로운 직업 기회 (PDF 내용이 여기에 추가될 수 있습니다.)"
                    required
                ></textarea>
            </div>

            <div>
                <label for="time" class="block text-lg font-semibold text-gray-700 mb-2">
                    발표 시간 (분):
                </label>
                <input
                    type="number"
                    id="time"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 ease-in-out shadow-sm"
                    placeholder="예: 10"
                    min="1"
                    required
                />
            </div>

            <button
                type="submit"
                id="generateButton"
                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
            >
                <span id="buttonText">스크립트 생성하기</span>
                <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>

        <!-- 스크립트 결과 섹션 -->
        <div id="scriptResult" class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-inner hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">생성된 발표 스크립트:</h2>
            <div id="scriptContent" class="prose max-w-none text-gray-700 leading-relaxed whitespace-pre-wrap">
                <!-- 생성된 스크립트가 여기에 표시됩니다. -->
            </div>
        </div>

        <!-- 에러 모달 -->
        <div id="errorModal" class="modal hidden">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal()">&times;</span>
                <h3 class="text-xl font-bold text-red-600 mb-4">오류 발생!</h3>
                <p id="errorMessage" class="text-gray-700 mb-6"></p>
                <button
                    onclick="closeModal()"
                    class="w-full bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition duration-200 ease-in-out"
                >
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // PDF.js 워커 스크립트 경로 설정 (필수)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // API 키 (Canvas 환경에서 자동으로 제공되므로 비워둠)
        const apiKey = "";

        // DOM 요소 가져오기
        const scriptForm = document.getElementById('scriptForm');
        const topicInput = document.getElementById('topic');
        const considerationsInput = document.getElementById('considerations');
        const timeInput = document.getElementById('time');
        const pdfUploadInput = document.getElementById('pdfUpload'); // PDF 업로드 input
        const pdfLoadingStatus = document.getElementById('pdfLoadingStatus'); // PDF 로딩 상태
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const scriptResult = document.getElementById('scriptResult');
        const scriptContent = document.getElementById('scriptContent');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');

        // 모달을 닫는 함수
        function closeModal() {
            errorModal.classList.add('hidden');
            errorMessage.textContent = '';
        }

        // PDF 파일 읽기 및 텍스트 추출 함수
        async function extractTextFromPdf(file) {
            pdfLoadingStatus.classList.remove('hidden'); // 로딩 상태 표시
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n'; // 페이지 구분자 추가
                }
                return fullText;
            } catch (error) {
                console.error('PDF 텍스트 추출 오류:', error);
                errorMessage.textContent = 'PDF 파일에서 텍스트를 추출하는 데 실패했습니다. 파일이 손상되었거나 지원되지 않는 형식일 수 있습니다.';
                errorModal.classList.remove('hidden');
                return null; // 오류 발생 시 null 반환
            } finally {
                pdfLoadingStatus.classList.add('hidden'); // 로딩 상태 숨김
            }
        }

        // PDF 파일 업로드 변경 이벤트 리스너
        pdfUploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.type !== 'application/pdf') {
                    errorMessage.textContent = 'PDF 파일만 업로드할 수 있습니다.';
                    errorModal.classList.remove('hidden');
                    pdfUploadInput.value = ''; // 파일 선택 초기화
                    return;
                }

                const pdfText = await extractTextFromPdf(file);
                if (pdfText) {
                    // 기존 내용이 있다면 줄 바꿈 추가 후 PDF 내용 추가
                    if (considerationsInput.value.trim() !== '') {
                        considerationsInput.value += '\n\n--- PDF 내용 시작 ---\n\n' + pdfText;
                    } else {
                        considerationsInput.value = pdfText;
                    }
                    // 스크롤을 맨 아래로 이동하여 PDF 내용이 보이도록 함
                    considerationsInput.scrollTop = considerationsInput.scrollHeight;
                }
            }
        });

        // 폼 제출 이벤트 리스너
        scriptForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // 기본 폼 제출 동작 방지

            // 이전 스크립트 및 에러 메시지 초기화
            scriptResult.classList.add('hidden');
            scriptContent.textContent = '';
            closeModal(); // 혹시 열려있을지 모르는 모달 닫기

            const topic = topicInput.value.trim();
            const considerations = considerationsInput.value.trim(); // PDF 내용이 이미 포함될 수 있음
            const time = timeInput.value.trim();

            // 입력 값 유효성 검사
            if (!topic || !considerations || !time) {
                errorMessage.textContent = '모든 필드를 입력해주세요.';
                errorModal.classList.remove('hidden');
                return;
            }

            const parsedTime = parseInt(time, 10);
            if (isNaN(parsedTime) || parsedTime <= 0) {
                errorMessage.textContent = '유효한 발표 시간을 입력해주세요 (양의 숫자).';
                errorModal.classList.remove('hidden');
                return;
            }

            // 로딩 상태 시작
            generateButton.disabled = true;
            buttonText.textContent = '스크립트 생성 중...';
            loadingSpinner.classList.remove('hidden');

            try {
                // Gemini API에 보낼 프롬프트 구성
                const prompt = `
                    다음 정보를 바탕으로 발표 스크립트를 작성해주세요.
                    발표 주제: ${topic}
                    주요 고려 사항: ${considerations}
                    발표 시간: ${parsedTime}분

                    스크립트는 발표 시간 내에 발표할 수 있도록 적절한 길이로 작성되어야 합니다.
                    서론, 본론, 결론으로 구성하고, 각 섹션에 대한 간략한 제목을 포함해주세요.
                    자연스럽고 전문적인 어조로 작성해주세요.
                `;

                // 채팅 기록 초기화 및 사용자 프롬프트 추가
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                // API 요청 페이로드
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                // Gemini API 호출
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 응답 파싱
                const result = await response.json();

                // 응답에서 스크립트 추출 및 표시
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    scriptContent.textContent = generatedText;
                    scriptResult.classList.remove('hidden'); // 스크립트 결과 섹션 표시
                } else {
                    // 응답 구조가 예상과 다른 경우
                    errorMessage.textContent = '스크립트 생성에 실패했습니다. 다시 시도해주세요.';
                    errorModal.classList.remove('hidden');
                    console.error('API 응답 구조 오류:', result);
                }
            } catch (err) {
                // 네트워크 오류 또는 기타 예외 처리
                errorMessage.textContent = '스크립트를 생성하는 중 오류가 발생했습니다. 네트워크 연결을 확인하거나 나중에 다시 시도해주세요.';
                errorModal.classList.remove('hidden');
                console.error('API 호출 오류:', err);
            } finally {
                // 로딩 상태 종료
                generateButton.disabled = false;
                buttonText.textContent = '스크립트 생성하기';
                loadingSpinner.classList.add('hidden');
            }
        });
    </script>

    <!-- Kakao Ad Script -->
    <ins class="kakao_ad_area" style="display:none;"
    data-ad-unit = "DAN-D3KIhJuCcXgQddta"
    data-ad-width = "160"
    data-ad-height = "600"></ins>
    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
</body>
</html>
